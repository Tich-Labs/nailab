<%# pricing grid â€” accepts optional local `stacked: true` to render single-column cards for previews %>
<% stacked = local_assigns[:stacked] %>
<% grid_classes = stacked ? 'space-y-4' : 'grid md:grid-cols-3 gap-10' %>
<div class="<%= grid_classes %>">
  <% current_tier = (defined?(current_user) && current_user&.subscription&.tier)&.to_s&.strip&.downcase %>
  <% logged_in = defined?(current_user) && current_user.present? %>
  <% pricing_tiers.each_with_index do |tier, idx| %>
    <% highlight = tier.fetch(:highlight, false) %>
    <% card_pad = stacked ? 'p-4' : 'p-8' %>
    <% title_cls = stacked ? 'text-xl' : 'text-2xl' %>
    <% price_cls = stacked ? 'text-2xl' : 'text-4xl' %>
    <% desc_mb = stacked ? 'mb-4' : 'mb-6' %>
    <% features_space = stacked ? 'space-y-2' : 'space-y-3' %>
    <% cta_padding = stacked ? 'px-4 py-2 text-sm' : 'px-6 py-3' %>
    <% card_border_bg = highlight ? 'border-nailab-purple bg-nailab-purple/10 scale-105 z-10' : 'border-gray-200 bg-white' %>
    <div class="flex flex-col rounded-2xl shadow-lg border-2 <%= card_border_bg %> <%= card_pad %> relative" data-tier-index="<%= idx %>">
      <% if highlight %>
          <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-nailab-purple text-white text-xs font-bold px-3 py-0.5 rounded-full shadow">Most Popular</span>
        <% end %>
      <% tier_name_norm = tier[:name].to_s.strip.downcase %>
      <% is_current = current_tier.present? && tier_name_norm == current_tier %>
      <% if is_current %>
        <span class="absolute top-3 right-3 bg-green-600 text-white text-xs font-semibold px-2 py-0.5 rounded">Your plan</span>
      <% end %>
      <h2 class="<%= title_cls %> font-bold text-gray-900 mb-2 text-center tier-name"><%= tier[:name] %></h2>
      <div class="<%= price_cls %> font-extrabold text-nailab-purple mb-2 text-center tier-price"><%= tier[:price] %></div>
      <p class="text-gray-700 <%= desc_mb %> text-center tier-desc"><%= tier[:description] %></p>
      <ul class="mb-6 <%= features_space %> tier-features">
        <% Array.wrap(tier[:features]).each do |feature| %>
          <li class="flex items-center <%= stacked ? 'space-x-3' : 'space-x-2' %>">
            <svg class="w-4 h-4 <%= stacked ? 'text-teal-500' : 'text-teal-500' %> flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            <span class="text-gray-800 text-sm"><%= feature %></span>
          </li>
        <% end %>
      </ul>
      <% cta_color = if highlight
        'bg-nailab-purple text-white hover:bg-nailab-purple'
      elsif tier[:name].to_s.strip.downcase == 'start basic'
        'bg-nailab-purple text-white hover:bg-nailab-purple'
      else
        'bg-nailab-teal text-white hover:bg-nailab-teal'
      end %>
      <% if is_current %>
        <a href="<%= defined?(founder_subscription_path) ? founder_subscription_path : (tier[:cta_link] || '/users/sign_up') %>" class="mt-auto block w-full text-center rounded-lg font-semibold transition-colors <%= cta_padding %> <%= stacked ? 'shadow-sm' : 'shadow-lg hover:shadow-xl' %> bg-gray-300 text-gray-700 tier-cta">
          Manage Plan
        </a>
      <% else %>
        <% if logged_in %>
          <a href="<%= new_founder_subscription_path(plan: tier[:name]) %>" class="mt-auto block w-full text-center rounded-lg font-semibold transition-colors <%= cta_padding %> <%= stacked ? 'shadow-sm' : 'shadow-lg hover:shadow-xl' %> <%= cta_color %> tier-cta">
            <%= tier[:cta] || 'Choose Plan' %>
          </a>
        <% else %>
          <a href="<%= tier[:cta_link] || '/users/sign_up' %>" class="mt-auto block w-full text-center rounded-lg font-semibold transition-colors <%= cta_padding %> <%= stacked ? 'shadow-sm' : 'shadow-lg hover:shadow-xl' %> <%= cta_color %> tier-cta">
            <%= tier[:cta] || 'Choose Plan' %>
          </a>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
