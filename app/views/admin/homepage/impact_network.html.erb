<h1 class="text-2xl font-bold mb-4">Impact Network â€” Manage Logos</h1>

<div class="mb-4">
  <%= link_to "Preview live section", root_path(anchor: "impact_network"), class: "ml-2 btn btn-secondary" %>
</div>

<!-- editor moved into left column so it stacks above the logos list -->

<div class="grid grid-cols-2 gap-8 mb-6">
  <div id="logo-editor" class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Editor</h2>
    <%= form_with url: admin_logos_path, id: 'logo-form', local: true, html: { multipart: true } do |f| %>
      <%= hidden_field_tag :logo_id, nil, id: 'logo-id' %>
      <%= hidden_field_tag :_method, nil, id: 'logo-method' %>
      <div class="mb-2">
        <%= label_tag :name, 'Name', class: 'block font-medium' %>
        <%= text_field_tag 'logo[name]', nil, id: 'logo-name', class: 'w-full form-input admin-form-input' %>
      </div>
      <div class="mb-2">
        <%= label_tag :image, 'Image', class: 'block font-medium' %>
        <%= file_field_tag 'logo[image]', accept: 'image/*', id: 'logo-image' %>
      </div>
      <div class="mb-2">
        <%= label_tag :display_order, 'Order', class: 'block font-medium' %>
        <%= number_field_tag 'logo[display_order]', 0, id: 'logo-order', class: 'w-32 form-input' %>
      </div>
      <div class="mb-2">
        <%= check_box_tag 'logo[active]', '1', true, id: 'logo-active' %>
        <%= label_tag 'logo-active', 'Active', class: 'ml-2' %>
      </div>
      <div class="flex items-center">
        <%= submit_tag 'Save', class: 'btn btn-primary' %>
        <%= button_tag 'Cancel', type: 'button', id: 'logo-cancel', class: 'ml-2 btn btn-secondary' %>
      </div>
    <% end %>
  </div>

  <div>
    <h2 class="font-semibold mb-2">Preview</h2>
    <div id="preview-container" class="bg-white p-4 rounded shadow admin-preview-scroll">
      <%= render partial: 'admin/homepage/impact_network_preview', locals: { logos: (@preview_logos || @logos.where(active: true)) } %>
    </div>
  </div>
</div>

<div class="bg-white rounded shadow overflow-y-auto" style="max-height:60vh;">
  <h2 class="font-semibold mb-2 px-4 pt-4">Logos</h2>
  <table class="w-full">
    <thead>
      <tr>
        <th class="p-2">Preview</th>
        <th>Name</th>
        <th>Order</th>
        <th>Active</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="impact-network-rows">
      <%= render partial: 'admin/homepage/impact_network_rows', locals: { logos: @logos } %>
    </tbody>
  </table>
</div>

<script>
  (function () {
    var container = document.getElementById('impact-network-rows');
    var form = document.getElementById('logo-form');
    var idField = document.getElementById('logo-id');
    var methodField = document.getElementById('logo-method');
    var nameField = document.getElementById('logo-name');
    var imageField = document.getElementById('logo-image');
    var orderField = document.getElementById('logo-order');
    var activeField = document.getElementById('logo-active');
    var cancelBtn = document.getElementById('logo-cancel');

    function resetForm() {
      if (!form) return;
      form.action = '/admin/logos';
      methodField.value = '';
      idField.value = '';
      nameField.value = '';
      if (imageField) imageField.value = '';
      orderField.value = 0;
      activeField.checked = true;
      var preview = document.getElementById('preview-container');
      if (preview) preview.innerHTML = '<div class="text-gray-500">Enter a new logo to preview here.</div>';
    }

    function escapeHtml(unsafe) {
      return String(unsafe || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function renderPreviewLogo(opts) {
      var name = escapeHtml(opts.name || '');
      var src = escapeHtml(opts.src || '');
      var img = src ? ('<img src="' + src + '" alt="' + name + '" class="mx-auto" style="max-width:240px; max-height:120px;"/>') : '<div class="text-gray-500">No image</div>';
      return '<div class="max-w-4xl mx-auto px-4 text-center">' +
        '<div class="flex justify-center">' + img + '</div>' +
        '<div class="mt-4 text-gray-700 font-medium">' + name + '</div>' +
        '</div>';
    }

    function handleEdit(e) {
      var tr = e.currentTarget.closest('tr');
      if (!tr) return;
      var id = tr.getAttribute('data-logo-id');
      var name = tr.getAttribute('data-logo-name') || '';
      var src = tr.querySelector('td[data-logo-src]') ? tr.querySelector('td[data-logo-src]').getAttribute('data-logo-src') : '';

      form.action = '/admin/logos/' + id;
      methodField.value = 'patch';
      idField.value = id;
      nameField.value = name;
      orderField.value = 0;
      activeField.checked = true;

      var preview = document.getElementById('preview-container');
      if (preview) preview.innerHTML = renderPreviewLogo({ name: name, src: src });
      document.getElementById('logo-editor').scrollIntoView({ behavior: 'smooth' });
    }

    function handlePreview(e) {
      var tr = e.currentTarget.closest('tr');
      if (!tr) return;
      var name = tr.getAttribute('data-logo-name') || '';
      var src = tr.querySelector('td[data-logo-src]') ? tr.querySelector('td[data-logo-src]').getAttribute('data-logo-src') : '';
      var preview = document.getElementById('preview-container');
      if (preview) preview.innerHTML = renderPreviewLogo({ name: name, src: src });
    }

    function wireButtons() {
      if (!container) return;
      container.querySelectorAll('.logo-edit-btn').forEach(function (btn) { btn.removeEventListener('click', handleEdit); btn.addEventListener('click', handleEdit); });
      container.querySelectorAll('.logo-preview-btn').forEach(function (btn) { btn.removeEventListener('click', handlePreview); btn.addEventListener('click', handlePreview); });
    }

    if (cancelBtn) cancelBtn.addEventListener('click', resetForm);

    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var fd = new FormData(form);
        var token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        var method = (methodField && methodField.value) || form.getAttribute('method') || 'post';
        var action = form.action;

        fetch(action, {
          method: method.toUpperCase() === 'PATCH' ? 'PATCH' : 'POST',
          headers: { 'X-CSRF-Token': token, 'Accept': 'application/json' },
          body: fd,
          credentials: 'same-origin'
        }).then(function (resp) {
          if (!resp.ok) return resp.json().then(function (j) { throw j; });
          return resp.json();
        }).then(function (data) {
          if (data.html_rows) {
            var tbody = document.getElementById('impact-network-rows');
            tbody.innerHTML = data.html_rows;
            wireButtons();
          }
          if (data.preview_html) {
            var preview = document.getElementById('preview-container');
            preview.innerHTML = data.preview_html;
          }
          resetForm();
        }).catch(function (err) {
          console.error('Save failed', err);
          alert((err && err.errors) ? err.errors.join('\n') : 'Save failed');
        });
      });
    }

    // wire initially
    wireButtons();
  })();
</script>
