<div class="content">
  <div class="page-header">
    <h1>Reply to Support Ticket #<%= @ticket.id %></h1>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Ticket Details</h3>
        </div>
        <div class="panel-body">
          <p><strong>Subject:</strong> <%= @ticket.subject %></p>
          <p><strong>User:</strong> <%= @ticket.user&.full_name || @ticket.user&.email %></p>
          <p><strong>Category:</strong> <%= @ticket.category %></p>
          <p><strong>Status:</strong> <%= @ticket.status.humanize %></p>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Conversation</h3>
        </div>
        <div class="panel-body">
          <div class="conversation-thread">
            <% @ticket.replies.order(:created_at).each do |reply| %>
              <%
                sender = reply.admin_reply? ? "Admin" : (reply.user&.full_name || reply.user&.email || "User")
                is_admin = reply.admin_reply?
                alert_class = is_admin ? "alert-info" : "alert-success"
                align_class = is_admin ? "text-right" : "text-left"
              %>
              <div class="message-container <%= align_class %>" style="margin-bottom: 15px;">
                <div class="alert <%= alert_class %>" style="display: inline-block; max-width: 80%; border-radius: 10px; padding: 12px 15px;">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                    <strong><%= sender %></strong> - <%= reply.created_at.strftime('%b %d, %Y at %I:%M %p') %>
                  </div>
                  <div style="white-space: pre-wrap; word-wrap: break-word;">
                    <%= reply.body %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Add Reply</h3>
        </div>
        <div class="panel-body">
          <%= form_tag rails_admin.url_for(action: :reply, model_name: 'SupportTicket', id: @ticket.id), method: :post do %>
            <div class="form-group">
              <%= label_tag :message, "Your Reply" %>
              <%= text_area_tag :message, "", class: "form-control", rows: 6, required: true %>
            </div>

            <div class="form-group">
              <%= label_tag :status, "Update Status (optional)" %>
              <%= select_tag :status, options_for_select([
                ["Keep current status", ""],
                ["Open", "open"],
                ["In Progress", "in_progress"],
                ["Resolved", "resolved"],
                ["Closed", "closed"]
              ], @ticket.status), class: "form-control" %>
            </div>

            <div class="form-group">
              <%= submit_tag "Send Reply", class: "btn btn-primary" %>
              <%= link_to "Cancel", rails_admin.show_path(model_name: 'SupportTicket', id: @ticket.id), class: "btn btn-default" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>