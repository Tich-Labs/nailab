<%# pricing grid â€” accepts optional local `stacked: true` to render single-column cards for previews %>
<% stacked = local_assigns[:stacked] %>
<% grid_classes = stacked ? 'space-y-4' : 'grid md:grid-cols-3 gap-8' %>
<div class="<%= grid_classes %>">
  <% current_tier = (defined?(current_user) && current_user&.subscription&.tier)&.to_s&.strip&.downcase %>
  <% logged_in = defined?(current_user) && current_user.present? %>
  <% pricing_tiers.each_with_index do |tier, idx| %>
    <% highlight = tier.fetch(:highlight, false) %>
    <% title_cls = stacked ? 'text-xl' : 'text-2xl' %>
    <% price_cls = stacked ? 'text-3xl' : 'text-4xl' %>
    <% card_styles = highlight ? 'ring-2 ring-nailab-purple scale-105 z-10 shadow-2xl' : 'shadow-lg' %>
    <div class="card bg-base-100 border border-base-300 rounded-xl <%= card_styles %> relative" data-tier-index="<%= idx %>">
      <% if highlight %>
        <div class="absolute -top-4 left-1/2 -translate-x-1/2 z-20">
          <span class="badge badge-lg bg-nailab-purple text-white font-bold">Most Popular</span>
        </div>
      <% end %>
      <div class="card-body p-6 sm:p-8 flex flex-col h-full <%= highlight ? 'pt-10' : '' %>">
        <% tier_name_norm = tier[:name].to_s.strip.downcase %>
        <% is_current = current_tier.present? && tier_name_norm == current_tier %>
        <% if is_current %>
          <div class="absolute top-4 right-4">
            <span class="badge badge-success badge-sm text-white font-semibold">Your plan</span>
          </div>
        <% end %>
        
        <div class="flex-1">
          <h2 class="<%= title_cls %> font-bold text-base-content mb-2 tier-name"><%= tier[:name] %></h2>
          <div class="<%= price_cls %> font-extrabold text-nailab-purple mb-1 tier-price"><%= tier[:price] %></div>
          <p class="text-sm text-base-content/70 mb-6 tier-desc"><%= tier[:description] %></p>
          
          <ul class="space-y-3 mb-8 tier-features">
            <% Array.wrap(tier[:features]).each do |feature| %>
              <li class="flex items-start gap-3">
                <svg class="w-5 h-5 text-nailab-teal flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                <span class="text-sm text-base-content"><%= feature %></span>
              </li>
            <% end %>
          </ul>
        </div>
        
        <div class="card-actions w-full mt-auto">
          <% if is_current %>
            <a href="<%= defined?(founder_subscription_path) ? founder_subscription_path : (tier[:cta_link] || '/users/sign_up') %>" class="btn btn-lg btn-outline rounded-lg w-full">
              Manage Plan
            </a>
          <% else %>
            <% btn_color = if highlight
              'btn-lg bg-nailab-purple text-white hover:bg-nailab-purple/90 border-nailab-purple'
            elsif tier[:name].to_s.strip.downcase == 'start basic'
              'btn-lg bg-nailab-purple text-white hover:bg-nailab-purple/90 border-nailab-purple'
            else
              'btn-lg bg-nailab-teal text-white hover:bg-nailab-teal/90 border-nailab-teal'
            end %>
            <% if logged_in %>
              <a href="<%= new_founder_subscription_path(plan: tier[:name]) %>" class="btn <%= btn_color %> rounded-lg w-full tier-cta">
                <%= tier[:cta] || 'Choose Plan' %>
              </a>
            <% else %>
              <a href="<%= tier[:cta_link] || '/users/sign_up' %>" class="btn <%= btn_color %> rounded-lg w-full tier-cta">
                <%= tier[:cta] || 'Choose Plan' %>
              </a>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
