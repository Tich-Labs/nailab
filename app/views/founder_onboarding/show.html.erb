<%# app/views/founder_onboarding/show.html.erb %>
<% steps = [
  { key: 'personal', label: 'Personal' },
  { key: 'startup', label: 'Startup' },
  { key: 'professional', label: 'Professional' },
  { key: 'mentorship', label: 'Mentorship' },
  { key: 'confirm', label: 'Confirm' }
] %>
<div class="max-w-2xl mx-auto mt-10 bg-white rounded-lg shadow-lg p-8">
  <!-- Step Indicator and Progress Bar -->
  <% step_index = steps.index { |s| s[:key] == @step } || 0 %>
  <% percent_complete = ((step_index + 1).to_f / steps.size * 100).round %>
  <div class="mb-8">
    <div class="flex justify-between items-center mb-4">
      <span class="text-sm font-medium text-gray-700">Step <%= step_index + 1 %> of <%= steps.size %></span>
      <span class="text-sm text-gray-500"><%= percent_complete %>% complete</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
      <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: <%= percent_complete %>%"></div>
    </div>
  </div>
  <%= form_with url: founder_onboarding_path(step: @step), method: :put, local: true, scope: 'founder_onboarding', id: 'founder-onboarding-main-form' do |f| %>
    <% if @errors.present? %>
      <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded">
        <h4 class="text-red-800 font-semibold mb-2">Please fix the following before continuing:</h4>
        <ul class="list-disc list-inside text-sm text-red-700">
          <% Array(@errors).each do |err| %>
            <li><%= err %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <% if @step == 'personal' %>
      <h2 class="text-2xl font-semibold mb-6">Founder Personal Information</h2>
      <%= f.fields_for :user_profile, @user_profile do |up| %>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <%= up.label :full_name, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= up.text_field :full_name, required: true, aria: { required: true }, placeholder: 'Enter your full name', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <%# Only show email if current_user is present %>
          <% if current_user %>
            <div>
              <%= label_tag :email, 'Email', class: 'block text-sm font-medium mb-1' %>
              <%= text_field_tag :email, current_user.email, class: 'input input-bordered w-full', readonly: true, aria: { readonly: true } %>
            </div>
          <% end %>
          <div>
            <%= up.label :phone, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= up.telephone_field :phone, required: true, aria: { required: true }, placeholder: 'Enter your phone number', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= up.label :country, 'Country', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= up.select :country, country_list, { prompt: 'Select country' }, class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= up.label :city, 'City', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= up.text_field :city, aria: { describedby: 'city-help' }, placeholder: 'Enter your city name', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
            <small id="city-help" class="text-gray-500">Enter your city name</small>
          </div>
          <div>
            <%= up.label :bio, 'Short bio', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= up.text_area :bio, placeholder: 'A short bio about you (minimum 30 characters)', rows: 4, class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
            <small class="text-gray-500">Briefly describe yourself and your role in the startup.</small>
          </div>
        </div>
      <% end %>
    <% elsif @step == 'startup' %>
      <h2 class="text-2xl font-semibold mb-6">Startup Details</h2>
      <%= f.fields_for :startup_profile, @startup_profile do |sp| %>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <%= sp.label :startup_name, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :startup_name, required: true, aria: { required: true }, placeholder: 'Enter your startup name', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :logo_url, 'Logo URL', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :logo_url, placeholder: 'Paste your logo URL', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :description, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_area :description, required: true, aria: { required: true }, maxlength: 300, placeholder: 'Describe your startup (max 300 chars)', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :stage, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.select :stage, (defined?(STAGE_OPTIONS) ? STAGE_OPTIONS : ['Idea', 'Early', 'Growth', 'Scaling', 'Other']), {}, { required: true, aria: { required: true }, class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' } %>
          </div>
          <div>
            <%= sp.label :target_market, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :target_market, required: true, aria: { required: true }, placeholder: 'Who is your target market?', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :value_proposition, 'Unique Value Proposition', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :value_proposition, required: true, aria: { required: true }, placeholder: 'What makes your startup unique?', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div class="flex items-start gap-3">
            <%= sp.check_box :profile_visibility, class: 'checkbox checkbox-primary mt-1' %>
            <div>
              <p class="text-sm font-medium text-gray-900">Share this profile with the Nailab community</p>
              <p class="text-sm text-gray-500">Enabling this lets mentors and partners see the public details you have provided.</p>
            </div>
          </div>
        </div>
      <% end %>
    <% elsif @step == 'professional' %>
      <h2 class="text-2xl font-semibold mb-6">Professional Background</h2>
      <%= f.fields_for :startup_profile, @startup_profile do |sp| %>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <%= sp.label :sector, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :sector, placeholder: 'Industry sector', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :stage, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :stage, placeholder: 'Startup stage', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :funding_stage, 'Funding Stage', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_field :funding_stage, placeholder: 'e.g. Seed, Series A', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :funding_raised, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.number_field :funding_raised, placeholder: 'Amount raised (USD)', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
        </div>
      <% end %>
    <% elsif @step == 'mentorship' %>
      <h2 class="text-2xl font-semibold mb-6">Mentorship & Challenges</h2>
      <%= f.fields_for :startup_profile, @startup_profile do |sp| %>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <%= sp.label :mentorship_areas, 'Areas where you need mentorship', class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <p class="text-sm text-gray-500 mb-3">Select all that apply</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <% areas = ['Business model refinement', 'Product-Market Fit', 'Access to customers/markets', 'Go-to-market planning', 'Product development', 'Pitching/Fundraising', 'Marketing/Branding', 'Team Building/HR', 'Budgeting/Finance', 'Market Expansion', 'Legal/Regulatory', 'Leadership Growth', 'Partnerships', 'Sales & Acquisition', 'Other'] %>
              <% areas.each do |area| %>
                <label class="flex items-center space-x-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                  <%= check_box_tag 'founder_onboarding[startup_profile][mentorship_areas][]', area,
                                    Array(@startup_profile&.mentorship_areas).include?(area),
                                    class: 'rounded border-gray-300 text-nailab-teal focus:ring-teal-500',
                                    required: false %>
                  <span class="text-sm"><%= area %></span>
                </label>
              <% end %>
            </div>
          </div>
          <div>
            <%= sp.label :challenge_details, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.text_area :challenge_details, placeholder: 'Describe your main challenges', class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' %>
          </div>
          <div>
            <%= sp.label :preferred_mentorship_mode, class: 'block text-sm font-medium text-gray-700 mb-2' %>
            <%= sp.select :preferred_mentorship_mode, ['One-on-one', 'Group', 'Virtual', 'In-person', 'Other'], {}, { required: true, class: 'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent' } %>
          </div>
        </div>
      <% end %>
    <% elsif @step == 'confirm' %>
      <h2 class="text-2xl font-semibold mb-6">Review & Confirm</h2>
      <p class="mb-4">Please review your details before submitting.</p>
      <div class="space-y-8">
        <!-- Founder Profile -->
        <div class="bg-gray-50 rounded-lg p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Founder Profile</h3>
            <%= link_to founder_onboarding_path(step: 'personal'), class: 'text-nailab-teal hover:text-nailab-teal text-sm' do %>
              <i class="fas fa-edit mr-1"></i> Edit
            <% end %>
          </div>
          <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Name:</dt>
              <dd class="text-sm text-gray-900"><%= @user_profile.full_name || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Email:</dt>
              <dd class="text-sm text-gray-900"><%= @user_profile.user&.email || current_user&.email || session.dig(:founder_onboarding_user_profile, :email) || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Phone:</dt>
              <dd class="text-sm text-gray-900"><%= @user_profile.phone || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Country:</dt>
              <dd class="text-sm text-gray-900"><%= @user_profile.country || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">City:</dt>
              <dd class="text-sm text-gray-900"><%= @user_profile.city || 'Not provided' %></dd>
            </div>
          </dl>
        </div>
        <!-- Startup Profile -->
        <div class="bg-gray-50 rounded-lg p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Startup Profile</h3>
            <%= link_to founder_onboarding_path(step: 'startup'), class: 'text-nailab-teal hover:text-nailab-teal text-sm' do %>
              <i class="fas fa-edit mr-1"></i> Edit
            <% end %>
          </div>
          <dl class="space-y-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Startup Name:</dt>
              <dd class="text-sm text-gray-900"><%= @startup_profile&.startup_name || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Description:</dt>
              <dd class="text-sm text-gray-900"><%= @startup_profile&.description || 'Not provided' %></dd>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Stage:</dt>
                <dd class="text-sm text-gray-900"><%= @startup_profile&.stage || 'Not provided' %></dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Target Market:</dt>
                <dd class="text-sm text-gray-900"><%= @startup_profile&.target_market || 'Not provided' %></dd>
              </div>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Unique Value Proposition:</dt>
              <dd class="text-sm text-gray-900"><%= @startup_profile&.value_proposition || 'Not provided' %></dd>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Sector:</dt>
                <dd class="text-sm text-gray-900"><%= @startup_profile&.sector || 'Not provided' %></dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Funding Stage:</dt>
                <dd class="text-sm text-gray-900"><%= @startup_profile&.funding_stage || 'Not provided' %></dd>
              </div>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Funding Raised:</dt>
              <dd class="text-sm text-gray-900"><%= @startup_profile&.funding_raised || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Mentorship Areas:</dt>
              <dd class="text-sm text-gray-900"><%= Array(@startup_profile&.mentorship_areas).join(', ').presence || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Challenge Details:</dt>
              <dd class="text-sm text-gray-900"><%= @startup_profile&.challenge_details || 'Not provided' %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Preferred Mentorship Mode:</dt>
              <dd class="text-sm text-gray-900"><%= @startup_profile&.preferred_mentorship_mode || 'Not provided' %></dd>
            </div>
          </dl>
        </div>
      </div>
      <% unless current_user %>
        <div class="mt-8 p-6 bg-teal-50 rounded-lg text-center">
          <h3 class="text-xl font-bold mb-2 text-nailab-teal">Thank you for completing the onboarding form!</h3>
          <p class="mb-4 text-gray-700">To finish, please create an account. You will receive a confirmation email after registration.</p>
          <%= link_to 'Create Account', new_founder_registration_path, class: 'btn btn-primary bg-nailab-teal hover:bg-nailab-teal text-white px-8 py-3 rounded-lg font-semibold shadow-lg' %>
        </div>
      <% end %>
    <% end %>
    <div class="flex justify-between mt-8">
      <% if @step != 'personal' %>
        <%= link_to 'Back', founder_onboarding_path(step: steps[steps.index { |s| s[:key] == @step } - 1][:key]), class: 'btn btn-outline btn-secondary' %>
      <% else %>
        <span></span>
      <% end %>
      <div class="flex gap-4">
        <%= button_tag type: 'submit', 
                    form: 'founder-onboarding-main-form',
                    formaction: founder_onboarding_save_and_exit_path(step: @step),
                    formmethod: 'patch',
                    class: "btn btn-outline border-gray-300 text-gray-700 hover:bg-gray-50 px-6 py-3 rounded-lg font-semibold" do %>
          <i class="fas fa-save mr-2"></i> Save & Exit
        <% end %>
        <% if @step == 'confirm' %>
          <% if current_user %>
            <%= f.submit 'Finish', class: 'btn btn-primary bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg' %>
          <% end %>
        <% else %>
          <%= f.submit 'Next', class: 'btn btn-primary bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg' %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
